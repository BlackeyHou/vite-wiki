# 配额

::: tip 本文主要描述配额相关逻辑，并非详细的技术文档，详细技术文档会在技术黄皮书里提及。

相关词汇解释：

* **配额**： 在Vite系统中，交易时使用配额来支付计算和存储资源。
* **${\rm PoW}$**： 即工作量证明（Proof of Work），简单来说就是用来证明进行了一定量的计算。
* **抵押**： 指账户中的一部分${\it vite}$被冻结，无法交易，无法使用。
* **抵押地址**：指抵押发起方。
* **配额受益地址**：指抵押成功后获得配额的账户地址。 :::

## 什么是配额

在以太坊的设计中，每个交易在发起时需要指定gas和gas price,从而与其他交易竞争写入账本的机会。这是一个典型的竞价模型，原则上可以通过价格有效调控供给和需求的平衡。但由于用户在出价之前，很难量化当前的供需情况，也无法预测其他竞争者的出价，很容易发生市场失灵（market failure）。而且，每次出价所竞争的资源都是针对一个交易的，没有一个按账户维度对资源进行合理配置的协议。

在Vite中，当用户发起一笔交易，即发起转账交易、部署合约、调用合约方法、发行新代币、注册超级节点、提取出块奖励、投票、抵押时，需要消耗一定的配额。Vite通过配额模型来调整供需平衡。

用户可以通过两种方式来获取更高的资源配额：

* 在发起交易时计算一个${\rm PoW}$；
* 在账户中抵押一定数量的${\it vite}$。

如果用户希望一次性地发起一笔交易，可以选择计算一个${\rm PoW}$来一次性的获取配额；如果希望频繁发起交易，可以抵押一定数量的${\it vite}$来获取持久的配额。

Vite提倡用户通过抵押的方式来获取配额。

## 配额使用规则

用户发起的交易类型不同，所需的配额也不同，测试网络中，各种交易类型所需的配额见下表：

|   交易类型    |  所需配额  |
|:---------:|:------:|
| 不带备注的转出交易 | 21000  |
|   转入交易    | 21000  |
| 注册超级节点交易  | 62200  |
| 更新注册信息交易  | 62200  |
| 注销超级节点交易  | 83200  |
| 提取出块奖励交易  | 238800 |
|   投票交易    | 62000  |
|  撤销投票交易   | 62000  |
| 抵押获取配额交易  | 21000  |
|  撤销抵押交易   | 21000  |
|   铸币交易    | 83200  |
| 撤回铸币抵押交易  | 83200  |

另外，对于转账交易中的备注，每个字符都需要收取额外的配额，每个0字符收取4配额，每个非0字符收取68配额。

例如，如果用十六进制编码来表示备注，发起一笔备注为0x0001（共两个字符，第一个字符为0，第二个字符非0）的转账交易，需要的配额为：

$${\it Q} = 21000 + 4 * 1 + 68 * 1 = 21072$$

## 配额计算逻辑

配额可以通过下面的公式来计算：

$${\it Q}={\it Qm} \times (1- \frac{2}{1+e^{\xi d \times \rho d +\xi s \times T \times \rho s}})$$

其中，

* ${\it Q}$: 一个账户的当前可用配额；
* ${\it Qm}$: 单个账户配额上限，和系统总吞吐以及账户总数相关；
* $\xi d$: 用户在发起一笔交易时计算出的${\rm PoW}$难度；
* $\rho d$: 通过计算${\rm PoW}$获取配额的权重；
* $\xi s$: 账户受益的抵押金额；
* $T$: 发起交易前等待的快照块高度，即当前交易引用的快照块高度和账户链中引用的上一个不同的快照块高度的高度差；
* $\rho s$: 抵押获取配额的权重。

根据上面的配额计算公式，一个用户账户当前可用的配额和**系统总吞吐**、**该用户账户的抵押受益金额**，**该用户账户发起交易前等待的快照块高度**和**发起交易时计算的PoW难度**相关。

目前测试网络中，各参数取值如下：

* ${\it Qm}$ = 1000000
* $\rho d$ = 6.259419649e-10
* $\rho s$ = 4.200627522e-24

为了计算方便，实际计算配额时，只计算$(\xi d \times \rho d +\xi s \times T \times \rho s)$的值，并将计算结果分段映射成相应的配额。映射表如下：

| $(\xi d \times \rho d +\xi s \times T \times \rho s)$ | ${\it Q}$ | 每等待一个快照块能发起的不带备注交易数量 | 大约相当于在不算${\rm PoW}$的情况下抵押多少${\it vite}$ | 大约相当于在不抵押的情况下计算多少难度的${\rm PoW}$ |
|:------------------------------------------------------------:|:----------:|:--------------------:|:-----------------------------------------:|:--------------------------------:|
|                             0.0                              |     0      |          0           |                     0                     |                0                 |
|                $(0.0, 0.042006175634155006]$                 |   21000    |          1           |                   10000                   |             67108864             |
|        $(0.042006175634155006, 0.08404944434245186]$         |   42000    |          2           |                   20009                   |            134276096             |
|         $(0.08404944434245186, 0.1261670961035256]$          |   63000    |          3           |                   30036                   |            201564160             |
|         $(0.1261670961035256, 0.16839681732546105]$          |   84000    |          4           |                   40089                   |            269029376             |
|         $(0.16839681732546105, 0.2107768956769977]$          |   105000   |          5           |                   50178                   |            336736256             |
|         $(0.2107768956769977, 0.25334643304410037]$          |   126000   |          6           |                   60312                   |            404742144             |
|         $(0.25334643304410037, 0.2961455696376917]$          |   147000   |          7           |                   70501                   |            473120768             |
|          $(0.2961455696376917, 0.3392157225669637]$          |   168000   |          8           |                   80754                   |            541929472             |
|          $(0.3392157225669637, 0.382599842575369]$           |   189000   |          9           |                   91082                   |            611241984             |
|          $(0.382599842575369, 0.4263426931297194]$           |   210000   |          10          |                  101495                   |            681119744             |
|          $(0.4263426931297194, 0.4704911566788094]$          |   231000   |          11          |                  112005                   |            751652864             |
|          $(0.4704911566788094, 0.5150945736855665]$          |   252000   |          12          |                  122623                   |            822910976             |
|          $(0.5150945736855665, 0.5602051210238872]$          |   273000   |          13          |                  133362                   |            894976000             |
|          $(0.5602051210238872, 0.605878237567604]$           |   294000   |          14          |                  144235                   |            967946240             |
|          $(0.605878237567604, 0.6521731063496397]$           |   315000   |          15          |                  155256                   |            1041903616            |
|          $(0.6521731063496397, 0.6991532046201573]$          |   336000   |          16          |                  166440                   |            1116962816            |
|          $(0.6991532046201573, 0.7468869355972497]$          |   357000   |          17          |                  177804                   |            1193222144            |
|          $(0.7468869355972497, 0.7954483588344243]$          |   378000   |          18          |                  189364                   |            1270800384            |
|          $(0.7954483588344243, 0.8449180401302736]$          |   399000   |          19          |                  201141                   |            1349836800            |
|          $(0.8449180401302736, 0.8953840470548413]$          |   420000   |          20          |                  213156                   |            1430462464            |
|          $(0.8953840470548413, 0.9469431228444231]$          |   441000   |          21          |                  225428                   |            1512824832            |
|          $(0.9469431228444231, 0.9997020801479394]$          |   462000   |          22          |                  237989                   |            1597120512            |
|          $(0.9997020801479394, 1.053779467629503]$           |   483000   |          23          |                  250862                   |            1683513344            |
|          $(1.053779467629503, 1.1093075777848576]$           |   504000   |          24          |                  264082                   |            1772216320            |
|          $(1.1093075777848576, 1.1664348850068706]$          |   525000   |          25          |                  277682                   |            1863491584            |
|          $(1.1664348850068706, 1.2253290311060194]$          |   546000   |          26          |                  291702                   |            1957568512            |
|          $(1.2253290311060194, 1.286180514353531]$           |   567000   |          27          |                  306188                   |            2054791168            |
|          $(1.286180514353531, 1.3492072924575544]$           |   588000   |          28          |                  321192                   |            2155479040            |
|          $(1.3492072924575544, 1.4146605870070175]$          |   609000   |          29          |                  336772                   |            2260041728            |
|          $(1.4146605870070175, 1.4828322881625378]$          |   630000   |          30          |                  353004                   |            2368962560            |
|          $(1.4828322881625378, 1.554064521717701]$           |   651000   |          31          |                  369958                   |            2482757632            |
|          $(1.554064521717701, 1.6287621852605034]$           |   672000   |          32          |                  387743                   |            2602090496            |
|          $(1.6287621852605034, 1.707409634545938]$           |   693000   |          33          |                  406468                   |            2727755776            |
|          $(1.707409634545938, 1.7905932883378723]$           |   714000   |          34          |                  426270                   |            2860646400            |
|          $(1.7905932883378723, 1.8790328663947373]$          |   735000   |          35          |                  447322                   |            3001933824            |
|           $(1.8790328663947373, 1.97362554890186]$           |   756000   |          36          |                  469840                   |            3153051648            |
|           $(1.97362554890186, 2.0755100566945326]$           |   777000   |          37          |                  494096                   |            3315826688            |
|          $(2.0755100566945326, 2.186162517630361]$           |   798000   |          38          |                  520436                   |            3492593664            |
|          $(2.186162517630361, 2.3075451472522963]$           |   819000   |          39          |                  549332                   |            3686514688            |
|          $(2.3075451472522963, 2.4423470353692043]$          |   840000   |          40          |                  581427                   |            3901882368            |
|          $(2.4423470353692043, 2.594395323511559]$           |   861000   |          41          |                  617620                   |            4144775168            |
|          $(2.594395323511559, 2.7694056956796604]$           |   882000   |          42          |                  659288                   |            4424400896            |
|          $(2.7694056956796604, 2.976475888792767]$           |   903000   |          43          |                  708576                   |            4755193856            |
|          $(2.976475888792767, 3.2314282909393213]$           |   924000   |          44          |                  769276                   |            5162500096            |
|          $(3.2314282909393213, 3.5656840708200748]$          |   945000   |          45          |                  848844                   |            5696520192            |
|          $(3.5656840708200748, 4.057395776090949]$           |   966000   |          46          |                  965904                   |            6482067456            |
|           $(4.057395776090949, 5.029431885090279]$           |   987000   |          47          |                  1197301                  |            8034975744            |

即，在不计算${\rm PoW}$的情况下，抵押10000${\it vite}$可以获得最高1 ${\rm TPS}$的交易频率，抵押20009可以获得最高2 ${\rm TPS}$的交易频率。抵押10${\it vite}$等待1000个快照块（约16分钟40秒）也可以发起一笔不带备注的转账交易。

## 获取配额的两种方式

### 抵押

用户可以发起一笔抵押交易来获取配额。抵押时，由抵押地址发起一笔抵押交易（实际上是调用内置合约），当该交易被内置合约接收并被快照链打包确认后，抵押受益账户就能获取到相应的配额。

#### 参数

* 抵押金额：抵押金额最少为10${\it vite}$。
* 配额受益地址：抵押成功后获取配额的账户，可以填写抵押地址，也可以填写其他账户地址。即Vite允许给别人抵押。

抵押的${\it vite}$会暂时从用户余额中扣除，这部分${\it vite}$在抵押期间不能用于交易。 抵押账户可以在抵押成功后等待259200个快照块（大约3天），取回抵押的金额。取回抵押时，同样由抵押地址发起一笔撤销抵押的交易，当该交易被内置合约接收并被快照链打包确认后，抵押受益账户也就不再能获得相应的配额。

### 计算PoW

用户可以在发起一笔交易时计算一个${\rm PoW}$来一次性获取配额。根据配额公式，在没有抵押的情况下，要发起一笔不带备注的转账交易，需要计算的${\rm PoW}$难度为 0x3FFFFFF。

测试网络中，Vite会提供计算${\rm PoW}$的矿池。Vite官方钱包提供通过计算PoW的方式获取交易配额的功能。

#### PoW计算公式

1. 首先将$difficulty$转换为$target$，计算公式为：

$target$ = 2**256 / (1 + 1/$difficulty$)

其中，

* $difficulty$: ${\rm PoW}$难度，长度为256位的数字，不足256位时前面补0；
* $target$: ${\rm PoW}$目标，长度为256位的数字，通常第0位为1。

例如，当$difficulty$ = 0x3FFFFFF 时，对应的$target$ = 0xFFFFFFC000000000。

2. 然后根据交易数据计算$nonce$，$nonce$即为工作量证明，计算时，不断将随机数赋值给$nonce$，直到满足下面的条件：

$$blake2b(address+prevHash) + nonce < target$$

其中，

* $blake2b$: Vite使用的哈希函数
* $address$: 用户账户的地址
* $prevHash$: 用户账户中最后一个账户块的哈希

## FAQ

* 一个抵押地址能否给多个配额受益地址抵押？

可以。需要发起多笔交易分别给不同的受益地址抵押，每一个配额受益地址的抵押到期时间不同。

* 一个抵押地址能否多次给同一个配额受益地址抵押？

可以。给同一个配额受益地址抵押时，抵押金额会累加，抵押到期的高度以最后一次抵押交易被内置合约接收时引用的快照块高度+259200为准。

* 抵押给一个配额受益地址的${\it vite}$是否可以分批取回？

可以。抵押到期后可以分批取回，取回操作不影响到期时间。

* 抵押还没到期是否可以取回？

不可以。但抵押到期后随时可以取回。

* 抵押获取的配额是否会用完？

通过抵押的方式获取的配额数量跟抵押受益金额和发起交易前等待的快照块高度有关，抵押的${\it vite}$如果没有取回，就可以持续获得配额。如果钱包中的当前配额展示为0，那么等待一段时间后展示的配额就会变多。

* 一个配额受益地址能否接受多个抵押地址的抵押？

可以。抵押的受益金额是多个抵押地址给这个受益地址抵押的金额总和。

* 入账交易是否需要消耗配额？

需要，一笔入账交易需要消耗21000配额。Vite中，转账交易的发起者和接收者需要分别消耗配额来执行出账交易和入账交易，此外，投票、注册超级节点、铸币、抵押、创建委托共识组等也需要消耗配额来发起交易，不同交易类型需要的配额不同。

* 一个账户收到的第一笔转账交易，在没有抵押的情况下，怎么接收？

如果没有抵押，可以计算${\rm PoW}$来一次性获取配额。