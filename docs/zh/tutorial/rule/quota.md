# 配额

::: tip
本文主要描述配额相关逻辑，并非详细的技术文档，详细技术文档会在技术黄皮书里提及。

相关词汇解释：
* **配额**： 在Vite系统中，交易时使用配额来支付计算和存储资源。
* **PoW**： 即工作量证明（Proof of Work），简单来说就是用来证明进行了一定量的计算。
* **抵押**： 指账户中的一部分vite被冻结，无法交易，无法使用。
* **抵押地址**：指抵押发起方。
* **配额受益地址**：指抵押成功后获得配额的账户地址。
:::

## 什么是配额

在以太坊的设计中，每个交易在发起时需要指定gas和gas price,从而与其他交易竞争写入账本的机会。这是一个典型的竞价模型，原则上可以通过价格有效调控供给和需求的平衡。但由于用户在出价之前，很难量化当前的供需情况，也无法预测其他竞争者的出价，很容易发生市场失灵（market failure）。而且，每次出价所竞争的资源都是针对一个交易的，没有一个按账户维度对资源进行合理配置的协议。

在Vite中，当用户发起一笔交易，即发起转账交易、部署合约、调用合约方法、发行新代币、注册超级节点、提取出块奖励、投票、抵押时，需要消耗一定的配额。Vite通过配额模型来调整供需平衡。

用户可以通过两种方式来获取更高的资源配额：
* 在发起交易时计算一个`PoW`；
* 在账户中抵押一定数量的vite。

如果用户希望一次性地发起一笔交易，可以选择计算一个`PoW`来一次性的获取配额；如果希望频繁发起交易，可以抵押一定数量的vite来获取持久的配额。

Vite提倡用户通过抵押的方式来获取配额。

## 配额使用规则

将“无备注转账交易”定义为“单位交易”（Unit Transaction），作为配额单位。

用户发起的交易类型不同，所需的配额也不同，测试网络中，各种交易类型所需的配额见下表：

|  交易类型  | 所需配额 | 所需配额（单位交易） |
|:------------:|:-----------:|:-----------:|
| 不带备注的转出交易 | 21000 | 1 |
| 转入交易 | 21000 | 1 |
| 注册超级节点交易 | 62200 | 2.9619 |
| 更新注册信息交易 | 62200 | 2.9619 |
| 注销超级节点交易 | 83200 | 3.9619 |
| 提取出块奖励交易 | 68200 | 3.2476 |
| 投票交易 | 62000 | 2.9524 |
| 撤销投票交易 | 62000 | 2.9524 |
| 抵押获取配额交易 | 82000 | 3.9048 |
| 撤销抵押交易 | 73000 | 3.4762 |
| 代理抵押获取配额交易 | 82000 | 3.9048 |
| 代理撤销抵押交易 | 73000 | 3.4762 |
| 铸币交易 | 104525 | 4.9774 |
| 增发代币交易 | 69325 | 3.3012 |
| 销毁代币交易 | 48837 | 2.3256 |
| 转移代币所有者交易 | 58981 | 2.8086 |
| 修改代币类型交易 | 63125 | 3.0060 |

对于转账交易中的备注，每个字符都需要收取额外的配额，每个字符收取68配额。

例如，如果用十六进制编码来表示备注，发起一笔备注为0x0001（共两个字符）的转账交易，需要的配额为`21000+68*2=21136`，即`1.0065`单位交易。

如果创建合约时指定了一个非零的确认数（即发送给合约的请求交易被确认多少次之后再出响应交易），那么这个合约的每个响应交易都需要额外收取`确认数 * 200`的配额。

注意：官方钱包会在转账的备注中默认填写两个字节的前缀，备注为空时不填，因此通过官方钱包转账时，如果填写了备注，会额外收取2 * 68的配额。详情见[vep-8](../../vep/vep-8.md)

## 配额计算逻辑

通过抵押或者计算PoW获得的配额可以通过下面的公式来计算：

$$Q_{PoW}=Qm \times (1- \frac{2}{1+e^{\xi d \times \rho d}})$$
$$Q_{Stake}=Qm \times (1- \frac{2}{1+e^{\xi s \times \rho s}})$$

其中，
* $Q_{PoW}$: 通过计算PoW获得的配额，通过计算PoW获得的配额是一次性的，只能在当前交易中使用；
* $Q_{Stake}$: 通过抵押获得的配额，抵押获得的配额是长期的，并且可以累积，最多累积75个快照块；
* $Qm$: 单个账户配额上限，和系统总吞吐以及账户总数相关；
* $\xi d$: 用户在发起一笔交易时计算出的`PoW`难度；
* $\rho d$: 通过计算`PoW`获取配额的权重；
* $\xi s$: 账户受益的抵押金额；
* $\rho s$: 抵押获取配额的权重。

目前测试网络中，各参数取值如下：
* $Qm$ = 1000000
* $\rho d$ = 6.259408129e-10
* $\rho s$ = 4.201037667e-24

用户在每个快照块内可以发起的单位交易数`UTPS`的计算公式如下：
$$UTPS=\frac{Q_{Stake}}{21000}$$

一个账户的当前可用配额取决于`UTPS`和这个账户在过去74个快照块期间的配额使用情况，例如，一个账户通过抵押获得了1`UTPS`的配额，在过去74个快照块期间没有发起交易，那么这个账户的当前可用配额为75`UTPS`。

一个账户在发起一笔交易时的可用配额取决于UTPS、这个账户在过去74个快照块期间的配额使用情况和发起这笔交易时通过计算PoW获得的一次性配额，例如，一个账户通过抵押获得了1`UTPS`的配额，在过去74个快照块期间没有发起交易，并且计算了一个2`UTPS`难度的PoW，那么这个账户在发起一笔新交易时，最多可以使用77`UTPS`的配额。

为了计算方便，实际计算配额时，只计算$(\xi d \times \rho d)$或者$(\xi s \times T \times \rho s)$的值，并将计算结果分段映射成相应的配额。映射表如下：

|  $(\xi d \times \rho d)$ 或者 $(\xi s \times \rho s)$ | $Q$ | UTPS | 大约相当于在不算`PoW`的情况下抵押多少vite | 大约相当于在不抵押的情况下计算多少难度的`PoW` |
|:------------:|:-----------:|:-----------:|:-----------:|:-----------:|
| 0.0 | 0 | 0 | 0 | 0 |
| $(0, 0.0005600000146345639]$ | 280 | 1/75 | 134 | 894654 |
| $(0.0005600000146345639, 0.0011200001170773874]$ | 560 | 2/75 | 267 | 1789307 |
| $(0.0011200001170773874, 0.0016800003951362111]$ | 840 | 3/75 | 400 | 2683961 |
| $(0.0016800003951362111, 0.002240000936619286]$ | 1120 | 4/75 | 534 | 3578615 |
| $(0.002240000936619286, 0.002800001829335484]$ | 1400 | 5/75 | 667 | 4473270 |
| $(0.002800001829335484, 0.003360003161093523]$ | 1680 | 6/75 | 800 | 5367925 |
| $(0.003360003161093523, 0.003920005019702078]$ | 1960 | 7/75 | 934 | 6262581 |
| $(0.003920005019702078, 0.004480007492972107]$ | 2240 | 8/75 | 1067 | 7157239 |
| $(0.004480007492972107, 0.0050400106687125265]$ | 2520 | 9/75 | 1200 | 8051897 |
| $(0.0050400106687125265, 0.005600014634735637]$ | 2800 | 10/75 | 1334 | 8946557 |
| $(0.005600014634735637, 0.006160019478852362]$ | 3080 | 11/75 | 1467 | 9841218 |
| $(0.006160019478852362, 0.006720025288875452]$ | 3360 | 12/75 | 1600 | 10735880 |
| $(0.006720025288875452, 0.0072800321526182606]$ | 3640 | 13/75 | 1733 | 11630544 |
| $(0.0072800321526182606, 0.007840040157895736]$ | 3920 | 14/75 | 1867 | 12525211 |
| $(0.007840040157895736, 0.008400049392522762]$ | 4200 | 15/75 | 2000 | 13419879 |
| $(0.008400049392522762, 0.008960059944316465]$ | 4480 | 16/75 | 2133 | 14314549 |
| $(0.008960059944316465, 0.009520071901094992]$ | 4760 | 17/75 | 2267 | 15209221 |
| $(0.009520071901094992, 0.01008008535067674]$ | 5040 | 18/75 | 2400 | 16103896 |
| $(0.01008008535067674, 0.010640100380883094]$ | 5320 | 19/75 | 2533 | 16998573 |
| $(0.010640100380883094, 0.011200117079536328]$ | 5600 | 20/75 | 2667 | 17893253 |
| $(0.011200117079536328, 0.011760135534459705]$ | 5880 | 21/75 | 2800 | 18787936 |
| $(0.011760135534459705, 0.012320155833478902]$ | 6160 | 22/75 | 2933 | 19682622 |
| $(0.012320155833478902, 0.012880178064420343]$ | 6440 | 23/75 | 3066 | 20577310 |
| $(0.012880178064420343, 0.013440202315113498]$ | 6720 | 24/75 | 3200 | 21472002 |
| $(0.013440202315113498, 0.01400022867338966]$ | 7000 | 25/75 | 3333 | 22366698 |
| $(0.01400022867338966, 0.01456025722708073]$ | 7280 | 26/75 | 3466 | 23261397 |
| $(0.01456025722708073, 0.015120288064022377]$ | 7560 | 27/75 | 3600 | 24156099 |
| $(0.015120288064022377, 0.015680321272051077]$ | 7840 | 28/75 | 3733 | 25050806 |
| $(0.015680321272051077, 0.01624035693900638]$ | 8120 | 29/75 | 3866 | 25945516 |
| $(0.01624035693900638, 0.016800395152729273]$ | 8400 | 30/75 | 4000 | 26840230 |
| $(0.016800395152729273, 0.017360436001064444]$ | 8680 | 31/75 | 4133 | 27734949 |
| $(0.017360436001064444, 0.01792047957185776]$ | 8960 | 32/75 | 4266 | 28629672 |
| $(0.01792047957185776, 0.018480525952958973]$ | 9240 | 33/75 | 4400 | 29524399 |
| $(0.018480525952958973, 0.019040575232219203]$ | 9520 | 34/75 | 4533 | 30419131 |
| $(0.019040575232219203, 0.019600627497492765]$ | 9800 | 35/75 | 4666 | 31313868 |
| $(0.019600627497492765, 0.020160682836636825]$ | 10080 | 36/75 | 4799 | 32208609 |
| $(0.020160682836636825, 0.020720741337511922]$ | 10360 | 37/75 | 4933 | 33103356 |
| $(0.020720741337511922, 0.021280803087980315]$ | 10640 | 38/75 | 5066 | 33998108 |
| $(0.021280803087980315, 0.021840868175909127]$ | 10920 | 39/75 | 5199 | 34892865 |
| $(0.021840868175909127, 0.022400936689166498]$ | 11200 | 40/75 | 5333 | 35787628 |
| $(0.022400936689166498, 0.022961008715626032]$ | 11480 | 41/75 | 5466 | 36682396 |
| $(0.022961008715626032, 0.02352108434316254]$ | 11760 | 42/75 | 5599 | 37577171 |
| $(0.02352108434316254, 0.024081163659656016]$ | 12040 | 43/75 | 5733 | 38471951 |
| $(0.024081163659656016, 0.02464124675298827]$ | 12320 | 44/75 | 5866 | 39366737 |
| $(0.02464124675298827, 0.025201333711046034]$ | 12600 | 45/75 | 5999 | 40261529 |
| $(0.025201333711046034, 0.025761424621719303]$ | 12880 | 46/75 | 6133 | 41156327 |
| $(0.025761424621719303, 0.02632151957290144]$ | 13160 | 47/75 | 6266 | 42051132 |
| $(0.02632151957290144, 0.026881618652489236]$ | 13440 | 48/75 | 6399 | 42945944 |
| $(0.026881618652489236, 0.027441721948384734]$ | 13720 | 49/75 | 6533 | 43840762 |
| $(0.027441721948384734, 0.028001829548493135]$ | 14000 | 50/75 | 6666 | 44735587 |
| $(0.028001829548493135, 0.02856194154072289]$ | 14280 | 51/75 | 6799 | 45630419 |
| $(0.02856194154072289, 0.02912205801298835]$ | 14560 | 52/75 | 6933 | 46525259 |
| $(0.02912205801298835, 0.029682179053206414]$ | 14840 | 53/75 | 7066 | 47420105 |
| $(0.029682179053206414, 0.030242304749299606]$ | 15120 | 54/75 | 7199 | 48314960 |
| $(0.030242304749299606, 0.030802435189193574]$ | 15400 | 55/75 | 7333 | 49209821 |
| $(0.030802435189193574, 0.03136257046081975]$ | 15680 | 56/75 | 7466 | 50104691 |
| $(0.03136257046081975, 0.03192271065211283]$ | 15960 | 57/75 | 7599 | 50999568 |
| $(0.03192271065211283, 0.03248285585101344]$ | 16240 | 58/75 | 7733 | 51894453 |
| $(0.03248285585101344, 0.03304300614546563]$ | 16520 | 59/75 | 7866 | 52789346 |
| $(0.03304300614546563, 0.033603161623419094]$ | 16800 | 60/75 | 7999 | 53684248 |
| $(0.033603161623419094, 0.03416332237282837]$ | 17080 | 61/75 | 8133 | 54579158 |
| $(0.03416332237282837, 0.03472348848165249]$ | 17360 | 62/75 | 8266 | 55474077 |
| $(0.03472348848165249, 0.03528366003785593]$ | 17640 | 63/75 | 8399 | 56369004 |
| $(0.03528366003785593, 0.03584383712940819]$ | 17920 | 64/75 | 8533 | 57263940 |
| $(0.03584383712940819, 0.036404019844283514]$ | 18200 | 65/75 | 8666 | 58158886 |
| $(0.036404019844283514, 0.036964208270462595]$ | 18480 | 66/75 | 8799 | 59053840 |
| $(0.036964208270462595, 0.037524402495930566]$ | 18760 | 67/75 | 8933 | 59948804 |
| $(0.037524402495930566, 0.038084602608677874]$ | 19040 | 68/75 | 9066 | 60843776 |
| $(0.038084602608677874, 0.03864480869670122]$ | 19320 | 69/75 | 9199 | 61738759 |
| $(0.03864480869670122, 0.03920502084800278]$ | 19600 | 70/75 | 9333 | 62633751 |
| $(0.03920502084800278, 0.039765239150590236]$ | 19880 | 71/75 | 9466 | 63528753 |
| $(0.039765239150590236, 0.04032546369247644]$ | 20160 | 72/75 | 9599 | 64423765 |
| $(0.04032546369247644, 0.04088569456168163]$ | 20440 | 73/75 | 9733 | 65318787 |
| $(0.04088569456168163, 0.04144593184623087]$ | 20720 | 74/75 | 9866 | 66213820 |
| $(0, 0.042006175634155006]$ | 21000 | 1 | 10000 | 67108863 |
| $(0.042006175634155006, 0.08404944434245186]$ | 42000 | 2 | 20007 | 134276984 |
| $(0.08404944434245186, 0.1261670961035256]$ | 63000 | 3 | 30033 | 201563940 |
| $(0.1261670961035256, 0.16839681732546105]$ | 84000 | 4 | 40085 | 3733274509 |
| $(0.16839681732546105, 0.2107768956769977]$ | 105000 | 5 | 50173 | 290666828 |
| $(0.2107768956769977, 0.25334643304410037]$ | 126000 | 6 | 60306 | 310523977 |
| $(0.25334643304410037, 0.2961455696376917]$ | 147000 | 7 | 70494 | 360275060 |
| $(0.2961455696376917, 0.3392157225669637]$ | 168000 | 8 | 80746 | 428403748 |
| $(0.3392157225669637, 0.382599842575369]$ | 189000 | 9 | 91073 | 496921930 |
| $(0.382599842575369, 0.4263426931297194]$ | 210000 | 10 | 101486 | 565896574 |
| $(0.4263426931297194, 0.4704911566788094]$ | 231000 | 11 | 111995 | 635397250 |
| $(0.4704911566788094, 0.5150945736855665]$ | 252000 | 12 | 122612 | 705496588 |
| $(0.5150945736855665, 0.5602051210238872]$ | 273000 | 13 | 133350 | 776270783 |
| $(0.5602051210238872, 0.605878237567604]$ | 294000 | 14 | 144222 | 847800161 |
| $(0.605878237567604, 0.6521731063496397]$ | 315000 | 15 | 155241 | 920169805 |
| $(0.6521731063496397, 0.6991532046201573]$ | 336000 | 16 | 166424 | 993470265 |
| $(0.6991532046201573, 0.7468869355972497]$ | 357000 | 17 | 177787 | 1067798363 |
| $(0.7468869355972497, 0.7954483588344243]$ | 378000 | 18 | 189346 | 1143258118 |
| $(0.7954483588344243, 0.8449180401302736]$ | 399000 | 19 | 201122 | 1219961801 |
| $(0.8449180401302736, 0.8953840470548413]$ | 420000 | 20 | 213135 | 1298031169 |
| $(0.8953840470548413, 0.9469431228444231]$ | 441000 | 21 | 225407 | 1377598894 |
| $(0.9469431228444231, 0.9997020801479394]$ | 462000 | 22 | 237966 | 1458810249 |
| $(0.9997020801479394, 1.053779467629503]$ | 483000 | 23 | 250838 | 1541825095 |
| $(1.053779467629503, 1.1093075777848576]$ | 504000 | 24 | 264056 | 1626820249 |
| $(1.1093075777848576, 1.1664348850068706]$ | 525000 | 25 | 277654 | 1713992319 |
| $(1.1664348850068706, 1.2253290311060194]$ | 546000 | 26 | 291673 | 1803561138 |
| $(1.2253290311060194, 1.286180514353531]$ | 567000 | 27 | 306158 | 1895773931 |
| $(1.286180514353531, 1.3492072924575544]$ | 588000 | 28 | 321161 | 1990910446 |
| $(1.3492072924575544, 1.4146605870070175]$ | 609000 | 29 | 336741 | 2089289313 |
| $(1.4146605870070175, 1.4828322881625378]$ | 630000 | 30 | 352969 | 2191275997 |
| $(1.4828322881625378, 1.554064521717701]$ | 651000 | 31 | 369924 | 2297292878 |
| $(1.554064521717701, 1.6287621852605034]$ | 672000 | 32 | 387705 | 2407832162 |
| $(1.6287621852605034, 1.707409634545938]$ | 693000 | 33 | 406426 | 2523472634 |
| $(1.707409634545938, 1.7905932883378723]$ | 714000 | 34 | 426227 | 2644901733 |
| $(1.7905932883378723, 1.8790328663947373]$ | 735000 | 35 | 447279 | 2772945111 |
| $(1.8790328663947373, 1.97362554890186]$ | 756000 | 36 | 469795 | 2908606929 |
| $(1.97362554890186, 2.0755100566945326]$ | 777000 | 37 | 494048 | 3053125976 |
| $(2.0755100566945326, 2.186162517630361]$ | 798000 | 38 | 520387 | 3208055683 |
| $(2.186162517630361, 2.3075451472522963]$ | 819000 | 39 | 549280 | 3375381406 |
| $(2.3075451472522963, 2.4423470353692043]$ | 840000 | 40 | 581368 | 3557697962 |
| $(2.4423470353692043, 2.594395323511559]$ | 861000 | 41 | 617561 | 4144793358 |
| $(2.594395323511559, 2.7694056956796604]$ | 882000 | 42 | 659220 | 4424389078 |
| $(2.7694056956796604, 2.976475888792767]$ | 903000 | 43 | 708510 | 4755203412 |
| $(2.976475888792767, 3.2314282909393213]$ | 924000 | 44 | 769198 | 5162514130 |
| $(3.2314282909393213, 3.5656840708200748]$ | 945000 | 45 | 848763 | 5696519539 |
| $(3.5656840708200748, 4.057395776090949]$ | 966000 | 46 | 965808 | 6482075769 |
| $(4.057395776090949, 5.029431885090279]$ | 987000 | 47 | 1197189 | 8034995932 |

即，在不计算`PoW`的情况下，抵押10000vite可以获得1`UTPS`的交易频率，抵押20007可以获得2`UTPS`的交易频率。抵押134vite等待75个快照块（约1分钟15秒）也可以发起一笔不带备注的转账交易。

## 获取配额的两种方式

### 抵押

用户可以发起一笔抵押交易来获取配额。抵押时，由抵押地址发起一笔抵押交易（实际上是调用内置合约），当该交易被内置合约接收并被快照链打包确认后，抵押受益账户就能获取到相应的配额。

#### 参数
* 抵押金额：抵押金额最少为134vite。
* 配额受益地址：抵押成功后获取配额的账户，可以填写抵押地址，也可以填写其他账户地址。即Vite允许给别人抵押。

抵押的vite会暂时从用户余额中扣除，这部分vite在抵押期间不能用于交易。
抵押账户可以在抵押成功后等待259200个快照块（大约3天），取回抵押的金额。取回抵押时，同样由抵押地址发起一笔撤销抵押的交易，当该交易被内置合约接收并被快照链打包确认后，抵押受益账户也就不再能获得相应的配额。

### 计算PoW

用户可以在发起一笔交易时计算一个`PoW`来一次性获取配额。根据配额公式，在没有抵押的情况下，要发起一笔不带备注的转账交易，需要计算的`PoW`难度为 0x3FFFFFF。

测试网络中，Vite会提供计算`PoW`的矿池。Vite官方钱包提供通过计算PoW的方式获取交易配额的功能。

#### PoW计算公式

1. 首先将$difficulty$转换为$target$，计算公式为：

$target$ = 2**256 / (1 + 1/$difficulty$)

其中，
* $difficulty$: `PoW`难度，长度为256位的数字，不足256位时前面补0；
* $target$: `PoW`目标，长度为256位的数字，通常第0位为1。

例如，当$difficulty$ = 0x3FFFFFF 时，对应的$target$ = 0xFFFFFFC000000000。

2. 然后根据交易数据计算$nonce$，$nonce$即为工作量证明，计算时，不断将随机数赋值给$nonce$，直到满足下面的条件：

$$blake2b(address+prevHash) + nonce < target$$

其中，
* $blake2b$: Vite使用的哈希函数
* $address$: 用户账户的地址
* $prevHash$: 用户账户中最后一个账户块的哈希

## 代理抵押

代理抵押是指，A账户委托B账户抵押一定数量的vite给C账户。此时抵押地址是A账户，配额受益地址是C账户，B账户为代理地址。代理抵押取回时，由A账户委托B账户取回之前抵押给C账户的vite。

## FAQ

* 一个抵押地址能否给多个配额受益地址抵押？

可以。需要发起多笔交易分别给不同的受益地址抵押，每一个配额受益地址的抵押到期时间不同。

* 一个抵押地址能否多次给同一个配额受益地址抵押？

可以。给同一个配额受益地址抵押时，抵押金额会累加，抵押到期的高度以最后一次抵押请求交易被快照的快照块高度+259200为准。

* 抵押给一个配额受益地址的vite是否可以分批取回？

可以。抵押到期后可以分批取回，取回操作不影响到期时间。

* 抵押还没到期是否可以取回？

不可以。但抵押到期后随时可以取回。

* 抵押获取的配额是否会用完？

通过抵押的方式获取的配额数量跟抵押受益金额和发起交易前74个快照块内的交易配额使用情况相关，抵押的vite如果没有取回，就可以持续获得配额。如果钱包中的当前配额展示为0，那么等待一段时间后展示的配额就会变多。

* 一个配额受益地址能否接受多个抵押地址的抵押？

可以。抵押的受益金额是多个抵押地址给这个受益地址抵押的金额总和。

* 入账交易是否需要消耗配额？

需要，一笔入账交易需要消耗21000配额。Vite中，转账交易的发起者和接收者需要分别消耗配额来执行出账交易和入账交易，此外，投票、注册超级节点、铸币、抵押、创建委托共识组等也需要消耗配额来发起交易，不同交易类型需要的配额不同。

* 一个账户收到的第一笔转账交易，在没有抵押的情况下，怎么接收？

如果没有抵押，可以计算`PoW`来一次性获取配额。
