# 超级节点

> 本文主要描述有关HDPOS以及超级节点相关规则

Vite 快照链采用和DPOS共识算法，在核心逻辑上和BTS的DPOS算法一致，Vite 在这之上做了些许改进。

Vite 网络中的区块生产者称为：Snapshot Block Producer，简称**SBP**。

**相关改动简要如下（详细规则请阅读下文）**：

* **SBP注册**：注册SBP需要抵押1m的vite（测试网络需要抵押0.5m vite）
* **出块权**：每一轮：前25个节点随机选出23个出块，排名26-100名的节点随机选择2个来出块
* **出块奖励**：出块奖励的50%分配给出块者，50%分配给前100名超级节点（按投票数权重来计算）

## SBP注册

传统的DPOS算法中，注册委托代理节点需要消耗支付一定量的token，但是在vite里，我们提倡通过**抵押**的方式来获取资源和资格。
在vite里可以通过抵押获取**配额**（交易配额），也可以通过抵押获得SBP的运行资格。

### 抵押规则

注册SBP需要抵押vite，可以通过取消SBP资格来取回抵押的vite，也就是说，如果想一直保持SBP资格，则必须一直抵押vite。

**什么是抵押？**

指账户中的一部分vite被冻结，无法交易。在目前的设计里（第一版测试网络），SBP注册抵押的vite无法用于**抵押获取配额**，后续考虑改成：**注册SBP抵押的vite依然可以用于抵押获取配额**。

**抵押数量：**

* 主网：*1m vite*
* 测试网络：*0.5m vite*

**抵押时长：**

注册SBP抵押的vite不能立即取回，需要在**7776000**块（约3个月）之后通过发起一个**取消SBP资格**的交易来取回抵押的vite。

这里有设置一个*三个月*的冻结时间，是为了防止有人频繁的抵押、撤回，导致整个网络SBP变动非常剧烈。

### 注册逻辑

传统DPOS算法里，注册超级节点的地址默认就是出块地址和出块奖励获得地址，而且注册成为超级节点之后就永久成为超级节点。

在vite中，注册超级节点的地址、出块地址、出块奖励获得地址可以是三个不同的地址。注册成为超级节点之后，如果**取消质押**就默认失去超级节点资格。

注册时，由A地址（抵押地址）发起一个调用**SBP注册**交易（实际上是调用内置合约），当该交易被快照链打包确认之后正式生效。

#### 参数

* **超级节点地址**：填写超级节点运行时用于出块的地址，也可以填写为发起**SBP注册**的地址。
推荐在服务器上生成一个新地址，然后将这个新地址作为超级节点地址，这样即使服务器被盗，不会影响超级节点抵押地址的安全。

* **超级节点名称**：SBP的名称

## 出块权

### 出块时间

Vite 快照链出块速度为1s，每个节点轮流出块，75s为一个轮次（每75s会重新统计票数，然后按票数排名选择出块节点），每轮到一次连续出块3个。

### 出块节点

Vite 每轮会选举出25个节点具有出块权的节点，25个节点选择规则：

* 从前25名节点（按投票比例排序）里随机选出23个（顺序是随机的），每轮出块概率为：23/25
* 从26名到100名节点里随机选出2个，每轮出块概率为：2/75

## 出块奖励

Vite 主网上线后，每年会增发不超过3%的vite用于超级节点奖励。目前在测试网络上的奖励固定为： `0.951293759512937595`

### 奖励分配

每个块的奖励会划分为两个部分：

#### 奖励出块者

每个块奖励的50%会给予该块的出块者作为奖励。

#### 奖励前100名SBP

用于奖励该轮次（75s为一轮）排名前100的超级节点，奖励规则如下：

* 按照这一轮该超级节点获得的投票数作为权重来瓜分这一轮的奖励
* 奖励领取只能领取*1152*轮次以前（大约一天以前）的奖励，领取奖励按*1152*为一个周期（约一天）来计算
* 在一个周期（约一天）内，可以计算出每个节点在这一周期内的在线率： `实际出块数/应该出块数`，在线率越高，奖励越多

#### 数学公式

* `l`: 节点在一个周期内实际出块数目
* `m`: 节点在一个周期内应该出块数目
* `n`: 节点在一个周期内，投票排名进入前100的轮次数总和，简称为**该节点参与的轮次数目**
* `Xn`: 该节点参与的轮次的第n轮实际共有多少个块产生
* `Wn`: 该节点参与的轮次的第n轮前100名节点获得的总投票数之和
* `Vn`: 该节点参与的轮次的第n轮获得的投票数目
* `R`: 每个块的奖励，测试网路固定为：`0.951293759512937595`

$$每一个周期（约一天）内应该获得的奖励 = \frac{l}{m}*\sum_{1}^{n }\left( \frac{Vn}{Wn}*R*0.5*Xn\right)$$




## FAQ

### 是否支持多人联合抵押?

目前不支持`多人联合抵押`，SBP注册的逻辑是由**内置智能合约**实现，后续智能合约上线之后，可以通过**合约调用合约**的方式来实现`多人联合抵押`。























