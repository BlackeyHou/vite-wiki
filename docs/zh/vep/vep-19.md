# VEP 19: 一种允许全节点不执行虚拟机也能信任交易并构建账户状态的方案

## 背景

go-vite节点在维护账本时，需要全量校验所有的快照块和账户块，目前在预主网上用PC同步900w个快照块和相应的账户块大约需要花费8个小时。对于只关注某几个账户的节点（例如dApp依赖的节点）来说，全量校验的耗时太长且没有必要。

账户块的校验主要包括账户块的签名、账户余额、配额、合约状态等。快照块的校验主要包括快照块的签名、快照的账户块的正确性。校验过程中耗时的点主要有两个：校验签名和执行虚拟机，本文主要讨论如何降低执行虚拟机的代价。

## 目标

在生成一个账户块时，通过执行虚拟机来校验这个账户的余额和配额是否充足，并更新这个账户的状态，最终账户余额和状态的变更会体现在这个块的字段上。其他节点在校验这个账户块时，通过执行虚拟机可以重新校验这个账户的余额和配额是否充足，并生成账户状态变更信息，通过验证本地执行结果和这个块上的字段是否一致，来校验这个块是否正确，并更新这个账户的本地状态。即节点在验证一个账户块时执行虚拟机是为了校验账户块的正确性，并生成新的状态。

本VEP的目标是：允许部分节点不执行虚拟机也能构建出账户状态并校验一个账户块的正确性，从而减轻这些节点的计算负担。

为此需要解决两个问题：

* 如何在不执行虚拟机的情况下获取最新状态。
* 如何信任新块。

## 方案

一种可能的方案是，将需要通过复杂计算才能构造出来的账户状态变更结果的哈希写进账户块中，广播账户块时带上具体的账户状态变更结果，不执行虚拟机的节点收到这类账户块时可以根据账户块上的哈希校验账户状态变更结果的正确性，并且可以直接根据变更结果来构造新的账户状态。

### 如何在不执行虚拟机的情况下获取最新状态

账户状态根据获取难度可以分为以下3类：

* 利用账户块上的字段进行简单计算即可生成的数据，包括账户余额、合约meta
* 执行合约代码后生成并且会影响后续交易验证的信息，包括使用的配额、合约状态、合约代码<sup>1</sup>
* 执行合约代码后生成并且不影响后续交易验证的信息，即vmlog

对于第1类状态，完全可以不执行虚拟机就能计算出来。

对于第2类状态，可以将状态变更结果的哈希写入账户块中，并将状态变更的结果随账户块一起广播，节点在收到这类账户块时，只要状态变更结果的哈希和账户块上的一致，就可以信任状态变更结果，这样就可以不执行虚拟机，直接构建出新的账户状态。

对于第3类状态，由于大部分节点都不关注（通常只有合约相关的dApp节点才关注），并且不影响后续交易的验证，相关节点可以单独执行关注的合约账户块来生成这类状态。

根据节点的使用场景，可以将节点分为3类：

* 超级节点：需要出块（包括快照块和合约账户块）。这类节点需要全量执行虚拟机，来确保出块的正确性。
* 普通全节点：可以发交易，支持链上数据查询，不关注vmlog。这类节点可以完全不执行虚拟机。
* dApp节点：支持部分账户的链上数据查询。这类节点可以按需执行虚拟机。

节点在启动时可以配置校验所有账户块时都执行虚拟机、校验所有账户块时都不执行虚拟机或者校验指定账户链上的账户块时执行虚拟机。如果是超级节点，则此配置无效，校验所有账户块时都需要执行虚拟机。

节点在构造账本时，有两个途径：

* 广播：节点验证完一笔新交易后向全网广播这笔交易。此时第一个广播这笔交易的节点（通过RPC接口发交易的节点或者合约委托共识组的出块节点）在生成这笔交易的同时生成了状态变更结果，因此广播交易时可以直接将状态变更结果随账户块一起广播。
* 同步：节点启动后尝试从其他节点批量拉取账本。由于现有节点并没有存储每笔交易修改的状态，如果额外存储状态变更结果，会增加所有节点的存储代价，因此同步时，收到的账户块上不带状态变更结果，节点在收到这类账户块时按需执行虚拟机。为了校验共识和配额，所有节点在同步过程中都需要对共识合约和配额合约链上的所有账户块全量执行虚拟机，来生成校验共识和配额时所需的合约状态。

综上所述，在收到广播的账户块时，超级节点需要全量执行虚拟机，全节点如果不关注vmlog在校验账户块时完全不需要执行虚拟机，如果关注vmlog则只在校验指定合约的账户块时执行虚拟机；在同步过程中，超级节点需要全量执行虚拟机，全节点如果不关注vmlog只需要在校验共识合约和配额合约链上的账户块时执行虚拟机，如果关注vmlog则只在校验共识合约、配额合约和关注的合约的账户块时执行虚拟机。

|  节点类型  | 广播 | 同步 |
|:------------:|:-----------:|:-----:|
| 超级节点 | 全量执行虚拟机 | 全量执行虚拟机 |
| 普通全节点 | 不执行虚拟机 | 对共识合约、配额合约的账户块执行虚拟机 |
| dApp节点 | 对指定合约的账户块执行虚拟机 | 对共识合约、配额合约和指定合约的账户块执行虚拟机 |


### 如何信任新块

对于新块的信任问题包含两种类型：信任账户块和信任快照块

对于一个账户块，如果这个账户块的字段正确（包括字段内容、状态变更结果的哈希、块哈希），依赖正确（包括哈希和高度依赖、请求交易和响应交易依赖、调用合约的请求交易被快照块确认的次数），签名符合共识（用户账户块的签名和公钥一致，合约账户块的签名和所属委托共识组的出块节点的公钥一致），并且执行虚拟机后得到的结果和这个块上的字段一致（虚拟机对账户余额、配额的校验和对状态变更的结果最终会提现在账户块的字段上），那么这个账户块是可信的。

如果校验一个账户块时没有执行虚拟机，并且符合前3个验证条件，那么当这个账户块被快照块快照时，认为这个账户块是可信的。如果这个账户块没有被快照块快照，那么找个块不一定是可信的。一个节点如果需要信任某个账户链上未被快照块的块，那么就需要在校验这些账户块时执行虚拟机。

对于一个快照块，如果这个快照块的字段正确（包括字段内容和哈希），依赖正确（包括哈希和高度），签名符合共识，快照的账户块可信（只需要满足账户块可信的前3个条件），那么这个快照块可信，这个快照块快照的账户块可信。

对于快照块的共识，节点启动时需要指定创世块对应的状态（默认使用预主网的状态），并根据创世块状态计算出第一轮共识，因此本地的第一轮共识是可信的。如果前一轮的共识结果是可信的，那么由于这一轮的共识结果被前一轮共识指定的节点确认过，因此这一轮的共识结果也是可信的。

综上所述，快照块的信任逻辑不变，账户块如果执行虚拟机，则信任逻辑不变，如果不执行虚拟机，则账户块需要被快照块快照才能完全信任。

## 总结

通过在广播账户块时携带状态变更信息，并将状态变更信息的哈希写进账户块中，可以允许部分全节点在不执行虚拟机的情况下也能信任收到的账户块和快照块，并构建出最新的账户状态，从而减轻这部分节点验证交易时的负担。

为了不增加节点的存储负担，同步时不携带状态变更信息，各类节点按需执行虚拟机。

---

1 智能合约的代码是在创建合约的响应交易时，通过执行创建合约请求交易的data字段生成的。data字段包含固定长度的合约参数（委托共识组id、代码类型、请求交易确认数、请求交易配额翻倍数等）、合约初始化代码（包含构造函数代码、合约代码、校验码）和构造函数入参。执行data字段后会返回合约代码，并生成合约的初始状态，因此合约代码属于必须执行虚拟机才能生成的状态信息。
